name: Amp Code Review

on:
  pull_request:
    types: [opened, reopened, ready_for_review, synchronize]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: string

jobs:
  review:
    # Skip draft PRs and untrusted contributors (unless manually triggered)
    if: ${{ github.event_name == 'workflow_dispatch' || (!github.event.pull_request.draft && contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.pull_request.author_association)) }}
    runs-on: ubuntu-latest
    timeout-minutes: 15

    concurrency:
      group: pr-review-${{ github.event.pull_request.number || inputs.pr_number }}
      cancel-in-progress: true

    permissions:
      pull-requests: write
      contents: read

    env:
      PR_NUMBER: ${{ github.event.pull_request.number || inputs.pr_number }}
      REPO: ${{ github.repository }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout PR branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr checkout "$PR_NUMBER"
          echo "HEAD_SHA=$(gh pr view "$PR_NUMBER" --json headRefOid --jq .headRefOid)" >> "$GITHUB_ENV"

      - name: Install Amp CLI
        run: |
          curl -fsSL https://ampcode.com/install.sh | bash
          echo "$HOME/.amp/bin" >> "$GITHUB_PATH"

      - name: Setup Zig
        uses: mlugg/setup-zig@fa65c4058643678a4e4a9a60513944a7d8d35440 # v2
        with:
          version: 0.15.2

      - name: Gather PR context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr view "$PR_NUMBER" --json title,body,author > pr.json
          gh pr diff "$PR_NUMBER" > diff.patch
          echo "Diff size: $(wc -c < diff.patch) bytes"

      - name: Run Amp review
        env:
          AMP_API_KEY: ${{ secrets.AMP_API_KEY }}
          AMP_TOOLBOX: .github/review-tools
          COMMENTS_FILE: ${{ runner.temp }}/comments.jsonl
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          touch "$COMMENTS_FILE"

          {
            cat <<'PROMPT'
          You are reviewing a pull request for a Zig project.

          Review this diff and leave inline comments on specific lines where you find:
          - Bugs or logic errors
          - Security issues
          - Memory safety problems (leaks, use-after-free, bounds issues)
          - Missing error handling
          - Style issues that violate the project conventions

          For trivial fixes (typos, obvious mistakes), include a suggested_fix.
          Be concise and constructive. Only comment on things that matter.
          If the code looks good, leave a general comment saying so.

          The project follows TigerStyle conventions:
          - Assertions for invariants at API boundaries
          - Explicit bounds on collections
          - Functions under 70 lines
          - camelCase for functions, snake_case for variables, PascalCase for types

          Here is the diff to review:
          PROMPT
            cat diff.patch
          } | amp -x --visibility public

      - name: Post review
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENTS_FILE: ${{ runner.temp }}/comments.jsonl
        run: .github/review-tools/post-review.sh
